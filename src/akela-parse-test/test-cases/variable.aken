use lib::base

Test_suite {
    .name = @file_name()
    .mute = true

    Test {
        .name = "declare and use an integer"
        .source = Source {
            "var a: i32 = 1\n"
            "a + 5\n"
        }
        .solo = true
        .has_error = false

        root = Ast_node {
            .type = Ast_type::Stmts
            .tu = Type_use {
                .td = base::i32
            }
            .blk_env = env1     # environment for the block
        }

        root

        # 'stmts' blocks each have an environment with symbols associated with
        # them. Environments are embedded into the AST and use a stack/tree
        # with 'prev' pointers to point down the stack to previous
        # environments. The environment stack/tree and sequence numbers are to
        # find lexically and temporally valid variables even after the AST is
        # fully created.

        env1 = Environment {
            .prev = env0                # base environment
            .symbols = Symbols {
                .a = Symbol {           # 'a' is declared in the block
                    .type = Symbol_type::Variable
                    .tu = Type_use {
                        .td = base::i32
                    }

                    # the 'a' variable can be used by id nodes
                    # that are in this environment or descendant
                    # environments and where the id seq is greater
                    # than the symbol seq
                    .seq = 0
                }
            }
        }

        # line 1
        var = Ast_node {
            @child_of(root)
            .type = Ast_type::Var
        }

        var_id = Ast_node {
            .@child_of(var)
            .type = Ast_type::Id
            .value = "a"
        }

        var_type = Ast_node {
            .@child_of(var)
            .type = Ast_type::Type
            .tu = Type_use {
                .td = base::i32
            }
        }

        var_number = Ast_node {
            .@child_of(var)
            .type = Ast_type::Number
            .value = "1"
            .tu = Type_use {
                .td = base::i32
            }
        }

        # line 2
        add = Ast_node {
            .@child_of(root)
            .type = Ast_type::Add
            .tu = Type_use {
                .td = base::i32
            }
        }

        add_a = Ast_node {
            .@child_of(add)
            .type = Ast_type::Id
            .value = "a"
            .tu = Type_use {
                .td = base::i32
            }
            .seq = 1            # search for ancestor environment with symbol
                                # 'a' that has a sequence number is less than 1

        add_number = Ast_node {
            .@child_of(add)
            .type = Ast_type::Number
            .value = "5"
            .tu = Type_use {
                .td = base::i32
            }
        }
    }
}